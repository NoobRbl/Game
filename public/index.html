<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Anime Battle Online</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui;-webkit-user-select:none;user-select:none}
  body{display:flex;align-items:center;justify-content:center}
  .card{width:92%;max-width:460px;padding:16px;border-radius:16px;
        background:rgba(20,25,40,.88);border:1px solid rgba(255,255,255,.10);
        box-shadow:0 10px 30px rgba(0,0,0,.45)}
  button,input{width:100%;margin-top:10px;padding:12px;border-radius:12px;
        border:1px solid rgba(255,255,255,.15);background:rgba(10,12,18,.85);color:#fff;outline:none}
  .row{display:flex;gap:10px}
  .row button{width:50%}
  #out{margin-top:12px;font-size:13px;word-break:break-all;opacity:.95;line-height:1.35}
</style>
</head>
<body>

<div id="menu" class="card">
  <div style="font-weight:800;font-size:16px;margin-bottom:6px">Anime Battle Online</div>

  <div class="row">
    <button id="btnGen">HOST + GEN LINK</button>
    <button id="btnCopy">COPY LINK</button>
  </div>

  <input id="joinInput" placeholder="Dán link hoặc nhập code (ABCDE)" />
  <button id="btnJoin">JOIN</button>

  <div id="out">Status: ready</div>
</div>

<script type="module">
  import { createNetClient } from "/src/net.js";

  const out = document.getElementById("out");
  const joinInput = document.getElementById("joinInput");
  const log = (m)=>{ console.log(m); out.textContent = String(m); };

  // ✅ chặn double-tap zoom + pinch zoom (mobile)
  let lastTap = 0;
  addEventListener("touchend", (e) => {
    const now = Date.now();
    if (now - lastTap < 300) e.preventDefault();
    lastTap = now;
  }, { passive:false });
  addEventListener("gesturestart", (e)=>e.preventDefault(), { passive:false });

  function normalizeRoomCode(raw){
    raw = String(raw || "").trim();
    if(!raw) return "";

    // nếu là hash
    if(raw.startsWith("#")) raw = raw.slice(1);

    // nếu là link full
    const m = raw.match(/ROOM=([A-Z0-9]+)/i);
    if(m) raw = m[1];

    raw = raw.replace(/[^A-Za-z0-9]/g,"").toUpperCase();
    return raw.slice(0,5); // code 5 ký tự
  }

  function parseHashRoom(){
    return normalizeRoomCode(location.hash || "");
  }

  let net = null;
  let lastLink = "";

  async function createRoom(){
    log("Creating room...");
    const res = await fetch("/api/room", { method:"POST" });
    const txt = await res.text();
    if(!res.ok) throw new Error("HTTP " + res.status + " " + txt.slice(0,120));
    const j = JSON.parse(txt);
    if(!j.ok || !j.code) throw new Error("API invalid: " + txt.slice(0,120));
    return String(j.code).toUpperCase();
  }

  function startNet(code){
    code = normalizeRoomCode(code);
    if(!code || code.length < 5){ log("❌ Invalid room code"); return; }

    if(net) net.close();
    log("Joining room " + code + " ...");

    net = createNetClient({
      code,

      onConnectError: (msg)=> log("Socket error ❌ " + msg),

      onJoined: ({ role, code }) => {
        log("JOINED ✅ role=" + role + " room=" + code);
      },

      onJoinFail: (e) => {
        log("JoinFail ❌ " + (e?.reason || "unknown") + (e?.code ? (" ("+e.code+")") : ""));
      },

      onInfo: (e) => {
        log("INFO: " + (e?.msg || JSON.stringify(e)));
      },

      onCountdown: (e) => {
        log("COUNTDOWN: " + JSON.stringify(e));
      },

      onState: (G) => {
        const ping = net?.getPing?.() ?? 0;
        const lh = G?.Left?.hp ?? "?";
        const rh = G?.Right?.hp ?? "?";
        out.textContent = `STATE ✅ ping:${ping}ms | HP ${lh} vs ${rh}`;
      },
    });
  }

  document.getElementById("btnGen").onclick = async ()=>{
    try{
      const code = await createRoom();
      const link = `${location.origin}/#ROOM=${code}`;
      lastLink = link;
      joinInput.value = link;
      location.hash = "ROOM=" + code;
      startNet(code); // ✅ auto join after create
    }catch(e){
      log("GEN ERROR ❌ " + (e?.message || e));
    }
  };

  document.getElementById("btnCopy").onclick = async ()=>{
    const text = lastLink || joinInput.value.trim();
    if(!text){ log("Chưa có link để copy"); return; }
    try{
      await navigator.clipboard.writeText(text);
      log("Copied ✅");
    }catch{
      joinInput.focus();
      joinInput.select();
      document.execCommand("copy");
      log("Copied (fallback) ✅");
    }
  };

  document.getElementById("btnJoin").onclick = ()=>{
    const code = normalizeRoomCode(joinInput.value || parseHashRoom());
    if(!code){ log("Dán link hoặc nhập code (ABCDE)"); return; }
    location.hash = "ROOM=" + code;
    startNet(code);
  };

  // ✅ auto join from link
  const auto = parseHashRoom();
  if(auto){
    joinInput.value = `${location.origin}/#ROOM=${auto}`;
    startNet(auto);
  }
</script>

</body>
</html>
