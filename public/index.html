<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Anime Battle Arena — Online 1v1</title>
  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1020; --card:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10); --txt:rgba(255,255,255,.92); --mut:rgba(255,255,255,.60);
      --a:#66e3ff; --b:#ff6b86; --ok:#71f3b2; --warn:#ffd66b;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    #app{position:fixed;inset:0;background:radial-gradient(1100px 700px at 30% 20%, #121a3a 0%, var(--bg0) 55%, #000 100%);}

    /* canvas 16:9 letterbox container */
    #stage{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
    }
    #cv{
      width:100vw; height:100vh; /* will letterbox in render */
      display:block;
      background:#000;
      touch-action:none;
    }

    /* HUD */
    #hud{
      position:absolute; inset:0; pointer-events:none;
    }
    .topbar{
      position:absolute; left:0; right:0; top:10px;
      display:flex; justify-content:space-between; align-items:flex-start;
      padding:0 14px;
      gap:10px;
    }
    .hpbox{
      width:min(44vw,520px);
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .hpname{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:12px;letter-spacing:.5px;color:var(--mut)}
    .bar{
      height:10px;border-radius:999px;background:rgba(255,255,255,.10);overflow:hidden;margin-top:8px;
      border:1px solid rgba(255,255,255,.10);
    }
    .fill{height:100%;width:50%; border-radius:999px;}
    .enbar{height:7px;margin-top:8px}
    .mid{
      pointer-events:none;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      min-width:210px;
      text-align:center;
      color:var(--txt);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }
    .mid .big{font-weight:800; letter-spacing:.8px}
    .mid .small{color:var(--mut); font-size:12px; margin-top:2px}

    /* Countdown overlay */
    #countdown{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      pointer-events:none;
    }
    #countdown .card{
      padding:18px 20px;
      border-radius:22px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      text-align:center;
      min-width:260px;
    }
    #countdown .t{
      font-weight:900;
      font-size:54px;
      letter-spacing:1px;
      color:#fff;
      text-shadow: 0 18px 55px rgba(0,0,0,.65);
      line-height:1;
    }
    #countdown .sub{margin-top:10px;color:var(--mut);font-weight:700;letter-spacing:.6px}

    /* Lobby */
    #lobby{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .panel{
      width:min(920px, 96vw);
      border-radius:26px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(14px);
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      min-height: 520px;
    }
    .left{
      padding:26px;
      background: radial-gradient(900px 520px at 20% 20%, rgba(102,227,255,.18) 0%, rgba(0,0,0,0) 55%),
                  radial-gradient(900px 520px at 60% 60%, rgba(255,107,134,.14) 0%, rgba(0,0,0,0) 55%);
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, rgba(102,227,255,.9), rgba(255,107,134,.8));
      box-shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    .title{
      font-weight:900; font-size:20px; letter-spacing:.6px; color:var(--txt);
    }
    .subtitle{
      color:var(--mut); font-weight:600; margin-top:2px; font-size:13px;
    }
    .hero{
      margin-top:22px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.28);
      padding:18px;
    }
    .hero h2{
      margin:0; font-size:18px; color:#fff; letter-spacing:.6px;
    }
    .hero p{
      margin:10px 0 0 0; color:var(--mut); line-height:1.55; font-weight:600; font-size:13px;
    }
    .kbd{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:14px;
    }
    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.78);
      font-weight:700; font-size:12px;
    }

    .right{
      padding:22px;
      background:rgba(0,0,0,.28);
      border-left:1px solid rgba(255,255,255,.10);
      display:flex; flex-direction:column; gap:12px;
    }
    .card{
      border-radius:20px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:16px;
    }
    .card h3{margin:0;color:#fff;letter-spacing:.5px;font-size:14px}
    .row{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
    button, input{
      font:inherit;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.28);
      color:var(--txt);
      padding:12px 12px;
      outline:none;
    }
    input{flex:1; min-width:160px}
    button{
      cursor:pointer;
      font-weight:800;
      letter-spacing:.5px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    button:active{transform:scale(.985)}
    .primary{background:linear-gradient(135deg, rgba(102,227,255,.28), rgba(255,107,134,.18))}
    .ok{background:linear-gradient(135deg, rgba(113,243,178,.25), rgba(102,227,255,.12))}
    .ghost{background:rgba(0,0,0,.22)}
    .tiny{padding:10px 12px; font-size:13px}
    .hint{margin-top:10px;color:var(--mut);font-size:12px;font-weight:650;line-height:1.4}
    .status{
      margin-top:12px;
      color:rgba(255,255,255,.88);
      font-weight:800;
      letter-spacing:.4px;
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      background:rgba(255,255,255,.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,.05);
    }
    .dot.on{background:rgba(113,243,178,.95); box-shadow:0 0 0 3px rgba(113,243,178,.15), 0 0 22px rgba(113,243,178,.35)}
    .muted{color:var(--mut); font-weight:700}

    /* Controls overlay */
    #controls{
      position:absolute; inset:0;
      pointer-events:none;
    }
    .btnpad{
      position:absolute;
      right:16px; bottom:16px;
      display:grid;
      grid-template-columns: repeat(3, 86px);
      grid-template-rows: repeat(3, 74px);
      gap:10px;
      pointer-events:auto;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
    }
    .gbtn{
      border-radius:18px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; justify-content:center;
      flex-direction:column;
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    .gbtn .t{font-weight:900;color:#fff;letter-spacing:.6px}
    .gbtn .k{margin-top:3px;font-size:11px;color:rgba(255,255,255,.62);font-weight:800}
    .gbtn:active{transform:scale(.985)}
    .gbtn.big{grid-column: 2 / span 2;}
    .joy{
      position:absolute;
      left:16px; bottom:16px;
      width:170px;height:170px;
      pointer-events:auto;
      touch-action:none;
      user-select:none;
      -webkit-user-select:none;
      display:flex; align-items:center; justify-content:center;
    }
    .joy .base{
      width:170px;height:170px;border-radius:50%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
      position:relative;
      backdrop-filter: blur(10px);
    }
    .joy .knob{
      position:absolute; left:50%; top:50%;
      width:72px;height:72px;border-radius:50%;
      transform: translate(-50%,-50%);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.12);
    }
    .footnote{
      position:absolute; left:0; right:0; bottom:8px;
      text-align:center; font-size:12px; color:rgba(255,255,255,.55);
      font-weight:700; letter-spacing:.4px;
      pointer-events:none;
    }

    @media (max-width: 820px){
      .panel{grid-template-columns:1fr; min-height: unset;}
      .right{border-left:none;border-top:1px solid rgba(255,255,255,.10)}
      .btnpad{grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 70px);}
    }
  </style>
</head>

<body>
<div id="app">
  <div id="stage"><canvas id="cv"></canvas></div>

  <!-- LOBBY -->
  <div id="lobby">
    <div class="panel">
      <div class="left">
        <div class="brand">
          <div class="logo"></div>
          <div>
            <div class="title">Anime Battle Arena</div>
            <div class="subtitle">Online 1v1 • 16:9 • Mobile joystick + keyboard</div>
          </div>
        </div>

        <div class="hero">
          <h2>Sẵn sàng cho trận đấu?</h2>
          <p>
            Host tạo phòng → lấy link mời bạn bè. Join vào là vào thẳng trận.
            Có đếm 3-2-1-READY để chuẩn bị. Camera tự follow + zoom theo khoảng cách,
            map giới hạn hai bên để tránh zoom “vô hạn”.
          </p>
          <div class="kbd">
            <span class="pill">Move: WASD / Joystick</span>
            <span class="pill">ATK: J</span>
            <span class="pill">JUMP: K (Double)</span>
            <span class="pill">DASH: L</span>
            <span class="pill">S1: U</span>
            <span class="pill">S2: I</span>
            <span class="pill">ULT: O</span>
            <span class="pill">SUB: P</span>
          </div>
        </div>

        <div class="hint">
          Tip: Bản online chuẩn là server “authoritative”. Client chỉ gửi input của mình,
          server tính toán rồi gửi trạng thái về nên sẽ không bị “trùng điều khiển”.
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h3>HOST</h3>
          <div class="row">
            <button class="primary tiny" id="btnHost">Create room</button>
            <button class="ghost tiny" id="btnCopy" disabled>Copy invite link</button>
          </div>
          <div class="hint" id="hostOut">Chưa tạo phòng.</div>
        </div>

        <div class="card">
          <h3>JOIN</h3>
          <div class="row">
            <input id="roomInput" placeholder="Nhập ROOM ID (vd: EN2RK4)" maxlength="12" />
            <button class="ok tiny" id="btnJoin">Join</button>
          </div>
          <div class="hint">Bạn cũng có thể mở link mời dạng <span class="muted">/#ROOM=XXXXXX</span>.</div>
        </div>

        <div class="card">
          <h3>STATUS</h3>
          <div class="status">
            <div style="display:flex;align-items:center;gap:10px">
              <div id="netDot" class="dot"></div>
              <span id="netText">Disconnected</span>
            </div>
            <div class="muted" id="playerSide">—</div>
          </div>
          <div class="hint" id="roomCount">Waiting…</div>
        </div>
      </div>
    </div>
  </div>

  <!-- HUD -->
  <div id="hud">
    <div class="topbar">
      <div class="hpbox">
        <div class="hpname"><span>P1</span><span id="p1hpText">—</span></div>
        <div class="bar"><div class="fill" id="p1hp" style="background:linear-gradient(90deg,var(--a),rgba(102,227,255,.35));width:0%"></div></div>
        <div class="bar enbar"><div class="fill" id="p1en" style="background:linear-gradient(90deg,var(--ok),rgba(113,243,178,.25));width:0%"></div></div>
      </div>

      <div class="mid">
        <div class="big" id="midTitle">FIGHT</div>
        <div class="small" id="midInfo">ping: — • room: —</div>
      </div>

      <div class="hpbox" style="text-align:right">
        <div class="hpname"><span id="p2hpText">—</span><span>P2</span></div>
        <div class="bar"><div class="fill" id="p2hp" style="background:linear-gradient(90deg,rgba(255,107,134,.35),var(--b));width:0%"></div></div>
        <div class="bar enbar"><div class="fill" id="p2en" style="background:linear-gradient(90deg,rgba(255,214,107,.25),var(--warn));width:0%"></div></div>
      </div>
    </div>

    <div id="countdown">
      <div class="card">
        <div class="t" id="cdText">3</div>
        <div class="sub">Get ready…</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <div class="joy" id="joyL">
      <div class="base">
        <div class="knob" id="stickL"></div>
      </div>
    </div>

    <div class="btnpad">
      <div class="gbtn" id="bUlt"><div class="t">ULT</div><div class="k">O</div></div>
      <div class="gbtn" id="bJump"><div class="t">JUMP</div><div class="k">K</div></div>
      <div class="gbtn" id="bS2"><div class="t">S2</div><div class="k">I</div></div>

      <div class="gbtn" id="bSub"><div class="t">SUB</div><div class="k">P</div></div>
      <div class="gbtn" id="bDash"><div class="t">DASH</div><div class="k">L</div></div>
      <div class="gbtn" id="bS1"><div class="t">S1</div><div class="k">U</div></div>

      <div class="gbtn big" id="bAtk"><div class="t">ATK</div><div class="k">J</div></div>
    </div>

    <div class="footnote" id="foot">16:9 • Online synced • Mobile joystick + buttons</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module">
  // =========================
  // INPUT (fixed edge + joystick)
  // =========================
  function setupInput(){
    const keys = new Set();
    addEventListener("keydown",(e)=>keys.add(e.key.toLowerCase()),{passive:true});
    addEventListener("keyup",(e)=>keys.delete(e.key.toLowerCase()),{passive:true});

    const touch={atk:false,dash:false,jump:false,s1:false,s2:false,ult:false,sub:false};

    const bindBtn=(id,name)=>{
      const el=document.getElementById(id);
      const down=(e)=>{ e.preventDefault(); touch[name]=true; };
      const up=(e)=>{ e.preventDefault(); touch[name]=false; };
      el.addEventListener("pointerdown",down,{passive:false});
      el.addEventListener("pointerup",up,{passive:false});
      el.addEventListener("pointercancel",up,{passive:false});
      el.addEventListener("pointerleave",up,{passive:false});
    };
    bindBtn("bAtk","atk"); bindBtn("bDash","dash"); bindBtn("bJump","jump");
    bindBtn("bS1","s1"); bindBtn("bS2","s2"); bindBtn("bUlt","ult"); bindBtn("bSub","sub");

    const joyL=document.getElementById("joyL");
    const stickL=document.getElementById("stickL");
    const joyVec={x:0,y:0};

    (function setupJoy(){
      let active=false,pid=null,center={x:0,y:0};
      const radius=52;
      function setStick(x,y){ stickL.style.transform=`translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; }
      function start(e){
        active=true; pid=e.pointerId;
        const r=joyL.getBoundingClientRect();
        center.x=r.left+r.width/2; center.y=r.top+r.height/2;
        move(e);
      }
      function move(e){
        if(!active||e.pointerId!==pid) return;
        const dx=e.clientX-center.x, dy=e.clientY-center.y;
        const len=Math.hypot(dx,dy)||1;
        const k=Math.min(1,len/radius);
        joyVec.x=(dx/len)*k; joyVec.y=(dy/len)*k;
        setStick(joyVec.x*radius, joyVec.y*radius);
        e.preventDefault();
      }
      function end(e){
        if(!active||e.pointerId!==pid) return;
        active=false; pid=null;
        joyVec.x=0; joyVec.y=0;
        setStick(0,0);
      }
      joyL.addEventListener("pointerdown",(e)=>{joyL.setPointerCapture(e.pointerId); start(e); e.preventDefault();},{passive:false});
      joyL.addEventListener("pointermove",move,{passive:false});
      joyL.addEventListener("pointerup",end,{passive:true});
      joyL.addEventListener("pointercancel",end,{passive:true});
    })();

    const makeInput=()=>({mx:0, atk:false, jump:false, dash:false, s1:false, s2:false, ult:false, sub:false});
    const edgeState=new Map();
    const once=(k,down)=>{
      const prev=edgeState.get(k)||false;
      if(down && !prev){ edgeState.set(k,true); return true; }
      if(!down) edgeState.set(k,false);
      return false;
    };

    function readLocalInput(){
      const inp=makeInput();
      let x=0;
      if(keys.has("a")) x-=1;
      if(keys.has("d")) x+=1;
      x += joyVec.x*1.05;
      inp.mx = Math.max(-1, Math.min(1, x));

      inp.atk  = keys.has("j") || touch.atk;
      inp.jump = keys.has("k") || touch.jump;
      inp.dash = keys.has("l") || touch.dash;
      inp.s1   = keys.has("u") || touch.s1;
      inp.s2   = keys.has("i") || touch.s2;
      inp.ult  = keys.has("o") || touch.ult;
      inp.sub  = keys.has("p") || touch.sub;
      return inp;
    }
    return { readLocalInput, once };
  }

  // =========================
  // RENDER (16:9 letterbox + camera zoom)
  // =========================
  function setupRender() {
    const canvas = document.getElementById("cv");
    const ctx = canvas.getContext("2d", { alpha:false });

    function resize() {
      const w = innerWidth, h = innerHeight;
      const dpr = devicePixelRatio || 1;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    addEventListener("resize", resize, {passive:true});
    resize();

    function computeView() {
      const W = innerWidth, H = innerHeight;
      const target = 16/9;
      let vw=W, vh=H, ox=0, oy=0;
      if (W/H > target) { vh=H; vw=H*target; ox=(W-vw)*0.5; }
      else { vw=W; vh=W/target; oy=(H-vh)*0.5; }
      return { W,H,vw,vh,ox,oy };
    }

    function worldToScreen(view, camX, zoom, wx, wy) {
      const {ox,oy,vw,vh} = view;
      const base = vw/1280;
      const scale = base * zoom;
      const sx = ox + vw/2 + (wx - camX) * scale;
      const sy = oy + vh*0.74 + wy * scale;
      return { sx, sy, scale };
    }

    function drawBackground(view){
      const {ox,oy,vw,vh} = view;
      const g = ctx.createLinearGradient(0,oy,0,oy+vh);
      g.addColorStop(0,"#0b1020");
      g.addColorStop(1,"#05070f");
      ctx.fillStyle=g; ctx.fillRect(ox,oy,vw,vh);

      // platform layer
      ctx.fillStyle="rgba(120,150,255,0.08)";
      ctx.fillRect(ox, oy+vh*0.56, vw, vh*0.44);

      // parallax “ruins”
      ctx.fillStyle="rgba(255,255,255,0.05)";
      for(let i=0;i<8;i++){
        const x = ox + (vw*(i/8)) + Math.sin(performance.now()*0.0004+i)*14;
        const w = 26 + (i%3)*12;
        const h = 110 + (i%4)*35;
        ctx.fillRect(x, oy+vh*0.56-h, w, h);
      }

      // ground line
      ctx.fillStyle="rgba(0,0,0,0.28)";
      ctx.fillRect(ox, oy+vh*0.74, vw, vh*0.02);
    }

    function drawFighter(p, isEnemy, view, camX, zoom){
      const o = worldToScreen(view, camX, zoom, p.x, p.y);
      const sx=o.sx, sy=o.sy, s=o.scale;

      ctx.save();
      ctx.translate(sx, sy);
      if(p.invul>0) ctx.globalAlpha = 0.6 + 0.25*Math.sin(performance.now()*0.03);

      // flip
      ctx.scale(p.face<0 ? -1 : 1, 1);

      // shadow
      ctx.fillStyle="rgba(0,0,0,0.25)";
      ctx.beginPath();
      ctx.ellipse(0, 6*s, 28*s, 10*s, 0, 0, Math.PI*2);
      ctx.fill();

      // body (placeholder)
      const body = isEnemy ? "#ff6a6a" : "#6ad5ff";
      ctx.fillStyle=body;
      ctx.fillRect(-22*s, -92*s, 44*s, 92*s);

      // head
      ctx.fillStyle="rgba(255,255,255,0.88)";
      ctx.fillRect(-13*s, -118*s, 26*s, 26*s);

      // eye line
      ctx.fillStyle="rgba(0,0,0,0.25)";
      ctx.fillRect(-8*s, -108*s, 16*s, 3*s);

      // attack lock indicator (tiny)
      if(p.atkLock>0){
        ctx.fillStyle="rgba(255,255,255,0.25)";
        ctx.fillRect(-10*s,-130*s,20*s,3*s);
      }

      ctx.restore();
      ctx.globalAlpha=1;
    }

    function drawFX(fx, view, camX, zoom){
      const {ox,oy,vw,vh} = view;
      const base = vw/1280;
      const scale = base * zoom;

      for(const e of fx){
        if(e.type==="hit"){
          // slash
          const p = worldToScreen(view, camX, zoom, e.x, e.y);
          ctx.save();
          ctx.translate(p.sx, p.sy);
          ctx.rotate((Math.random()*0.5-0.25));
          ctx.fillStyle = e.tag==="ult" ? "rgba(255,220,140,0.95)" : "rgba(190,255,255,0.9)";
          ctx.fillRect(-110*scale, -10*scale, 220*scale, 20*scale);
          ctx.restore();

          // damage popup
          ctx.textAlign="center";
          ctx.font = `${Math.max(14, 18*scale)}px system-ui,-apple-system,Segoe UI,Roboto`;
          ctx.fillStyle = e.crit ? "rgba(255,220,120,1)" : "rgba(255,255,255,0.95)";
          ctx.fillText(String(e.dmg), p.sx, p.sy - 22*scale);
        }
        if(e.type==="dash"){
          const p = worldToScreen(view, camX, zoom, e.x, e.y);
          ctx.fillStyle="rgba(160,255,255,0.18)";
          ctx.fillRect(p.sx-80*scale, p.sy-18*scale, 160*scale, 36*scale);
        }
        if(e.type==="ultStart"){
          // cinematic flash strip
          ctx.fillStyle="rgba(255,240,220,0.08)";
          ctx.fillRect(ox, oy, vw, vh*0.25);
          ctx.fillRect(ox, oy+vh*0.75, vw, vh*0.25);
        }
      }
    }

    function drawFrame(S){
      const view = computeView();
      const {W,H,ox,oy,vw,vh} = view;

      // black bars full screen
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,W,H);

      drawBackground(view);

      const camX = S?.camX ?? 0;
      const zoom = S?.zoom ?? 1.0;

      // map boundaries visible hint
      const wl = S?.world?.left ?? -420;
      const wr = S?.world?.right ?? 420;
      const Lp = worldToScreen(view, camX, zoom, wl, 0);
      const Rp = worldToScreen(view, camX, zoom, wr, 0);
      ctx.fillStyle="rgba(255,255,255,0.05)";
      ctx.fillRect(Lp.sx-4, oy+vh*0.56, 8, vh*0.18);
      ctx.fillRect(Rp.sx-4, oy+vh*0.56, 8, vh*0.18);

      if(S?.Left) drawFighter(S.Left, false, view, camX, zoom);
      if(S?.Right) drawFighter(S.Right, true, view, camX, zoom);

      drawFX(S?.fx || [], view, camX, zoom);
    }

    return { drawFrame };
  }

  // =========================
  // NET CLIENT (fix: mỗi người chỉ điều khiển 1 player)
  // =========================
  function setupNet({ onSnap, onInfo, onConnect, onDisconnect }){
    const socket = io();
    let mySide = null;
    let seq = 0;

    socket.on("connect", () => onConnect?.());
    socket.on("disconnect", () => onDisconnect?.());
    socket.on("snap", (S) => onSnap(S));
    socket.on("room:info", (I) => onInfo(I));

    const createRoom = () => new Promise(res => socket.emit("room:create", {}, r => res(r)));
    const joinRoom = (roomId) => new Promise(res => socket.emit("room:join", { roomId }, r => {
      if(r?.ok) mySide = r.side;
      res(r);
    }));

    const sendInp = (inp, edge) => {
      if(!mySide) return;
      socket.emit("inp", { seq: ++seq, inp, edge });
    };

    // ping
    let pingMs = 0;
    setInterval(() => {
      const t0 = performance.now();
      socket.emit("ping2");
      socket.once("pong2", () => pingMs = Math.round(performance.now() - t0));
    }, 900);

    return { socket, createRoom, joinRoom, sendInp, getSide:()=>mySide, getPing:()=>pingMs };
  }

  // =========================
  // UI HOOKS
  // =========================
  const lobby = document.getElementById("lobby");
  const btnHost = document.getElementById("btnHost");
  const btnJoin = document.getElementById("btnJoin");
  const btnCopy = document.getElementById("btnCopy");
  const hostOut = document.getElementById("hostOut");
  const roomInput = document.getElementById("roomInput");
  const netDot = document.getElementById("netDot");
  const netText = document.getElementById("netText");
  const playerSide = document.getElementById("playerSide");
  const roomCount = document.getElementById("roomCount");

  const midInfo = document.getElementById("midInfo");
  const midTitle = document.getElementById("midTitle");

  const p1hp = document.getElementById("p1hp");
  const p1en = document.getElementById("p1en");
  const p2hp = document.getElementById("p2hp");
  const p2en = document.getElementById("p2en");
  const p1hpText = document.getElementById("p1hpText");
  const p2hpText = document.getElementById("p2hpText");

  const cdWrap = document.getElementById("countdown");
  const cdText = document.getElementById("cdText");

  // =========================
  // GAME BOOT
  // =========================
  const input = setupInput();
  const render = setupRender();

  let SNAP = null;
  let currentRoom = null;

  const net = setupNet({
    onConnect(){
      netDot.classList.add("on");
      netText.textContent = "Connected";
    },
    onDisconnect(){
      netDot.classList.remove("on");
      netText.textContent = "Disconnected";
    },
    onInfo(I){
      roomCount.textContent = `Players in room: ${I.count}/2`;
    },
    onSnap(S){
      SNAP = S;

      // hide lobby once joined
      if(currentRoom) lobby.style.display = "none";

      // HUD
      const ping = net.getPing();
      midInfo.textContent = `ping: ${ping}ms • room: ${currentRoom || "—"}`;
      midTitle.textContent = (S.phase === "lobby") ? "LOBBY" : "FIGHT";

      // countdown overlay
      if(S.phase === "countdown" && S.cdText){
        cdWrap.style.display="flex";
        cdText.textContent = S.cdText;
      } else {
        cdWrap.style.display="none";
      }

      // HP/EN
      if(S.Left){
        p1hpText.textContent = `${Math.max(0, S.Left.hp|0)}/${S.Left.maxHp|0}`;
        const hpPct = (S.Left.hp / S.Left.maxHp) * 100;
        p1hp.style.width = `${Math.max(0, Math.min(100, hpPct))}%`;
        p1en.style.width = `${Math.max(0, Math.min(100, S.Left.en))}%`;
      }
      if(S.Right){
        p2hpText.textContent = `${Math.max(0, S.Right.hp|0)}/${S.Right.maxHp|0}`;
        const hpPct = (S.Right.hp / S.Right.maxHp) * 100;
        p2hp.style.width = `${Math.max(0, Math.min(100, hpPct))}%`;
        p2en.style.width = `${Math.max(0, Math.min(100, S.Right.en))}%`;
      }
    }
  });

  // Host button
  btnHost.addEventListener("click", async () => {
    const r = await net.createRoom();
    if(!r.ok) return;

    const roomId = r.roomId;
    const join = await net.joinRoom(roomId);
    if(!join.ok) return;

    currentRoom = roomId;
    playerSide.textContent = `Side: ${join.side}`;
    hostOut.textContent = `Room: ${roomId} • Share link đã sẵn`;
    btnCopy.disabled = false;

    const link = location.origin + "/#ROOM=" + roomId;
    history.replaceState(null,"", "#ROOM=" + roomId);

    btnCopy.onclick = async () => {
      try{ await navigator.clipboard.writeText(link); hostOut.textContent = `Copied: ${link}`; }
      catch{ hostOut.textContent = `Copy không được — link: ${link}`; }
    };
  });

  // Join button
  btnJoin.addEventListener("click", async () => {
    const roomId = (roomInput.value || "").trim().toUpperCase();
    if(!roomId) return;
    const r = await net.joinRoom(roomId);
    if(!r.ok){
      hostOut.textContent = `Join failed: ${r.err || "unknown"}`;
      return;
    }
    currentRoom = roomId;
    playerSide.textContent = `Side: ${r.side}`;
    history.replaceState(null,"", "#ROOM=" + roomId);
  });

  // auto join by hash
  const m = location.hash.match(/ROOM=([A-Z0-9]+)/i);
  if(m){
    const roomId = m[1].toUpperCase();
    roomInput.value = roomId;
  }

  // MAIN LOOP
  let last = performance.now();
  function frame(now){
    const dt = Math.min(0.05, (now - last) / 1000);
    last = now;

    // render snap
    if(SNAP) render.drawFrame(SNAP);

    // send input (client only sends own input)
    if(currentRoom){
      const inp = input.readLocalInput();
      const edge = {
        atk: input.once("atk", inp.atk),
        dash: input.once("dash", inp.dash),
        jump: input.once("jump", inp.jump),
        s1: input.once("s1", inp.s1),
        s2: input.once("s2", inp.s2),
        ult: input.once("ult", inp.ult),
        sub: input.once("sub", inp.sub),
      };
      net.sendInp(inp, edge);
    }

    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
</script>
</body>
</html>
