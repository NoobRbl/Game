
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game ƒê·ªëi Kh√°ng Online - Full Skills</title>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #111; color: white; font-family: Arial, sans-serif; touch-action: none; }
        #menu { padding: 20px; text-align: center; }
        #menu input { padding: 12px; width: 250px; margin: 10px; font-size: 16px; border-radius: 8px; }
        #menu button { padding: 12px 24px; font-size: 18px; margin: 10px; border-radius: 8px; background: #4a90e2; color: white; border: none; }
        #hostIdDisplay { font-size: 18px; font-weight: bold; color: #4a90e2; margin: 20px; }
        canvas { background: linear-gradient(to bottom, #87CEEB 0%, #98D8E9 70%, #aaf 100%); display: none; max-width: 100%; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #controls { position: fixed; bottom: 0; left: 0; right: 0; height: 180px; pointer-events: none; display: none; z-index: 200; }
        #joystick { position: absolute; left: 30px; bottom: 30px; width: 130px; height: 130px; pointer-events: auto; }
        #base { position: absolute; width: 130px; height: 130px; border-radius: 50%; background: rgba(100,100,100,0.4); border: 4px solid rgba(150,150,150,0.6); }
        #knob { position: absolute; left: 50%; top: 50%; width: 60px; height: 60px; margin: -30px 0 0 -30px; border-radius: 50%; background: rgba(255,255,255,0.9); border: 3px solid #666; }
        #actionPanel { position: absolute; right: 20px; bottom: 20px; display: grid; grid-template-columns: repeat(3, 80px); gap: 12px; pointer-events: auto; }
        #actionPanel button { width: 80px; height: 80px; border-radius: 50%; border: none; font-size: 28px; color: white; box-shadow: 0 6px 15px rgba(0,0,0,0.5); }
        #jumpBtn { background: #3498db; }
        #dashBtn { background: #7f8c8d; }
        #specialBtn { background: #9b59b6; }
        #attackBtn { background: #e74c3c; }
        #skill1Btn { background: #f39c12; }
        #skill2Btn { background: #f1c40f; }
        #ultimateBtn { grid-column: span 3; height: 90px; font-size: 32px; background: linear-gradient(#e67e22, #d35400); }
        #info { font-size: 14px; margin-top: 10px; opacity: 0.8; }
        @media (max-width: 768px) { #controls { display: block; } }
    </style>
</head>
<body>
    <div id="menu">
        <h1>ü•ä Game ƒê·ªëi Kh√°ng Online ü•ä</h1>
        <p>P1 (Host): Xanh - B√™n Tr√°i | P2 (Join): ƒê·ªè - B√™n Ph·∫£i</p>
        <button id="createBtn">T·∫°o Ph√≤ng (P1)</button>
        <div id="hostIdDisplay"></div>
        <br>
        <input id="joinIdInput" placeholder="Nh·∫≠p ID ph√≤ng b·∫°n b√®">
        <button id="joinBtn">Tham Gia (P2)</button>
        <div id="info">
            Mobile: Joystick di chuy·ªÉn ‚Ä¢ C√°c n√∫t b√™n ph·∫£i: Nh·∫£y, L∆∞·ªõt, Ph·ª•, ƒê√°nh, Skill1, Skill2, N·ªô<br>
            PC: A/D di chuy·ªÉn ‚Ä¢ W nh·∫£y ‚Ä¢ Space ƒë√°nh ‚Ä¢ Q Skill1 ‚Ä¢ E Skill2 ‚Ä¢ R N·ªô ‚Ä¢ Shift l∆∞·ªõt ‚Ä¢ F ph·ª•
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <div id="controls">
        <div id="joystick">
            <div id="base"></div>
            <div id="knob"></div>
        </div>
        <div id="actionPanel">
            <button id="jumpBtn">‚Üë</button>
            <button id="dashBtn">‚Üí</button>
            <button id="specialBtn">üõ°Ô∏è</button>
            <button id="attackBtn">üëä</button>
            <button id="skill1Btn">üî•</button>
            <button id="skill2Btn">‚ö°</button>
            <button id="ultimateBtn">üåü N·ªò</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gravity = 0.8;
        let groundY;

        class Fighter {
            constructor({ position, color, facing = 'right' }) {
                this.position = position;
                this.velocity = { x: 0, y: 0 };
                this.width = 60;
                this.height = 140;
                this.color = color;
                this.facing = facing;
                this.isAttacking = false;
                this.isDashing = false;
                this.isBlocking = false;
                this.damageCooldown = 0;
                this.dashCooldown = 0;
                this.cooldowns = { skill1: 0, skill2: 0, ultimate: 0, special: 0 };
                this.attackDamage = 8;
                this.attackWidth = 90;
                this.attackHeight = 60;
                this.attackOffsetY = 40;
                this.health = 100;
                this.name = '';
            }

            update() {
                this.draw();

                this.position.x += this.velocity.x;
                this.position.y += this.velocity.y;

                if (this.position.y + this.height + this.velocity.y >= groundY) {
                    this.velocity.y = 0;
                    this.position.y = groundY - this.height;
                } else {
                    this.velocity.y += gravity;
                }

                if (this.position.x < 20) this.position.x = 20;
                if (this.position.x + this.width > canvas.width - 20) this.position.x = canvas.width - this.width - 20;

                // cooldowns
                Object.keys(this.cooldowns).forEach(k => this.cooldowns[k] = Math.max(0, this.cooldowns[k] - 1));
                this.dashCooldown = Math.max(0, this.dashCooldown - 1);
                this.damageCooldown = Math.max(0, this.damageCooldown - 1);
            }

            jump() {
                if (this.velocity.y === 0) this.velocity.y = -20;
            }

            basicAttack() {
                if (this.isAttacking) return;
                this.isAttacking = true;
                this.attackDamage = 10;
                this.attackWidth = 90;
                this.attackHeight = 60;
                this.attackOffsetY = 40;
                setTimeout(() => this.isAttacking = false, 300);
            }

            skill1() {
                if (this.isAttacking || this.cooldowns.skill1 > 0) return;
                this.isAttacking = true;
                this.attackDamage = 18;
                this.attackWidth = 120;
                this.attackHeight = 70;
                this.attackOffsetY = 35;
                this.cooldowns.skill1 = 60;
                setTimeout(() => this.isAttacking = false, 400);
            }

            skill2() {
                if (this.isAttacking || this.cooldowns.skill2 > 0) return;
                this.isAttacking = true;
                this.attackDamage = 25;
                this.attackWidth = 140;
                this.attackHeight = 80;
                this.attackOffsetY = 30;
                this.cooldowns.skill2 = 90;
                setTimeout(() => this.isAttacking = false, 500);
            }

            ultimate() {
                if (this.isAttacking || this.cooldowns.ultimate > 0) return;
                this.isAttacking = true;
                this.attackDamage = 50;
                this.attackWidth = 220;
                this.attackHeight = 100;
                this.attackOffsetY = 20;
                this.cooldowns.ultimate = 900; // ~15s cooldown
                setTimeout(() => this.isAttacking = false, 800);
            }

            dash() {
                if (this.dashCooldown > 0) return;
                const dir = this.facing === 'right' ? 1 : -1;
                this.velocity.x += 30 * dir;
                this.isDashing = true;
                this.dashCooldown = 60;
                setTimeout(() => this.isDashing = false, 300);
            }

            special() {
                if (this.cooldowns.special > 0) return;
                this.isBlocking = true;
                this.cooldowns.special = 120;
                setTimeout(() => this.isBlocking = false, 1000);
            }

            draw() {
                // t√™n tr√™n ƒë·∫ßu
                ctx.fillStyle = 'white';
                ctx.font = 'bold 22px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.position.x + this.width / 2, this.position.y - 10);

                // th√¢n nh√¢n v·∫≠t (flip theo h∆∞·ªõng)
                const flip = this.facing === 'left';
                ctx.save();
                ctx.translate(this.position.x + this.width / 2, this.position.y + this.height / 2);
                if (flip) ctx.scale(-1, 1);
                ctx.translate(-this.width / 2, -this.height / 2);

                // hi·ªáu ·ª©ng dash
                if (this.isDashing) ctx.globalAlpha = 0.7;

                // th√¢n
                ctx.fillStyle = this.color;
                ctx.fillRect(8, 35, this.width - 16, this.height - 55);

                // ƒë·∫ßu
                ctx.fillStyle = this.color === 'blue' ? '#add8e6' : '#ffb6c1';
                ctx.beginPath();
                ctx.arc(this.width / 2, 15, 20, 0, Math.PI * 2);
                ctx.fill();

                // tay vung khi ƒë√°nh
                const armSwing = this.isAttacking ? Math.sin(Date.now() / 100) * 30 : 0;
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(10, 50);
                ctx.lineTo(10 + armSwing, 80);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(this.width - 10, 50);
                ctx.lineTo(this.width - 10 - armSwing, 80);
                ctx.stroke();

                ctx.restore();
                ctx.globalAlpha = 1;

                // h·ªôp t·∫•n c√¥ng
                if (this.isAttacking) {
                    const ax = flip ? this.position.x - this.attackWidth : this.position.x + this.width;
                    ctx.fillStyle = this.attackDamage > 40 ? 'rgba(255,215,0,0.5)' : this.attackDamage > 20 ? 'rgba(255,165,0,0.5)' : 'rgba(255,100,100,0.4)';
                    ctx.fillRect(ax, this.position.y + this.attackOffsetY, this.attackWidth, this.attackHeight);
                }

                // hi·ªáu ·ª©ng block
                if (this.isBlocking) {
                    ctx.strokeStyle = '#3498db';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(this.position.x - 10, this.position.y, this.width + 20, this.height);
                }
            }
        }

        let myFighter, opponentFighter, isHost = false, conn = null, peer = null;
        let myHealth = 100, opponentHealth = 100;
        const keys = { a: { pressed: false }, d: { pressed: false } };

        const menu = document.getElementById('menu');
        const controls = document.getElementById('controls');
        const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);

        function resizeCanvas() {
            canvas.width = Math.min(900, window.innerWidth - 40);
            canvas.height = canvas.width * 0.55;
            groundY = canvas.height - 70;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Joystick (gi·ªØ nguy√™n)
        let joystickActive = false;
        const base = document.getElementById('base');
        const knob = document.getElementById('knob');
        function updateJoystick(e) {
            const rect = base.getBoundingClientRect();
            const cx = rect.left + 65;
            const cy = rect.top + 65;
            let x = (e.touches ? e.touches[0].clientX : e.clientX) - cx;
            let y = (e.touches ? e.touches[0].clientY : e.clientY) - cy;
            const dist = Math.hypot(x, y);
            const max = 50;
            if (dist > max) { x = x / dist * max; y = y / dist * max; }
            knob.style.transform = `translate(${x}px, ${y}px)`;
            const horiz = x / max;
            const dead = 0.3;
            keys.a.pressed = horiz < -dead;
            keys.d.pressed = horiz > dead;
        }
        ['touchstart', 'mousedown'].forEach(ev => base.addEventListener(ev, e => { e.preventDefault(); joystickActive = true; updateJoystick(e); }));
        ['touchmove', 'mousemove'].forEach(ev => document.addEventListener(ev, e => { if (joystickActive) { e.preventDefault(); updateJoystick(e); } }));
        ['touchend', 'mouseup', 'touchcancel'].forEach(ev => document.addEventListener(ev, () => { joystickActive = false; knob.style.transform = 'translate(0,0)'; keys.a.pressed = keys.d.pressed = false; }));

        // N√∫t h√†nh ƒë·ªông (mobile + PC)
        const action = (fn) => { return (e) => { e?.preventDefault(); if (myFighter) fn(); } };

        document.getElementById('jumpBtn').addEventListener('touchstart', action(() => myFighter.jump()));
        document.getElementById('jumpBtn').addEventListener('mousedown', action(() => myFighter.jump()));

        document.getElementById('dashBtn').addEventListener('touchstart', action(() => myFighter.dash()));
        document.getElementById('dashBtn').addEventListener('mousedown', action(() => myFighter.dash()));

        document.getElementById('specialBtn').addEventListener('touchstart', action(() => myFighter.special()));
        document.getElementById('specialBtn').addEventListener('mousedown', action(() => myFighter.special()));

        document.getElementById('attackBtn').addEventListener('touchstart', action(() => myFighter.basicAttack()));
        document.getElementById('attackBtn').addEventListener('mousedown', action(() => myFighter.basicAttack()));

        document.getElementById('skill1Btn').addEventListener('touchstart', action(() => myFighter.skill1()));
        document.getElementById('skill1Btn').addEventListener('mousedown', action(() => myFighter.skill1()));

        document.getElementById('skill2Btn').addEventListener('touchstart', action(() => myFighter.skill2()));
        document.getElementById('skill2Btn').addEventListener('mousedown', action(() => myFighter.skill2()));

        document.getElementById('ultimateBtn').addEventListener('touchstart', action(() => myFighter.ultimate()));
        document.getElementById('ultimateBtn').addEventListener('mousedown', action(() => myFighter.ultimate()));

        // Keyboard
        window.addEventListener('keydown', e => {
            if (!myFighter) return;
            switch (e.key.toLowerCase()) {
                case 'a': keys.a.pressed = true; break;
                case 'd': keys.d.pressed = true; break;
                case 'w': myFighter.jump(); break;
                case ' ': e.preventDefault(); myFighter.basicAttack(); break;
                case 'q': myFighter.skill1(); break;
                case 'e': myFighter.skill2(); break;
                case 'r': myFighter.ultimate(); break;
                case 'shift': myFighter.dash(); break;
                case 'f': myFighter.special(); break;
            }
        });
        window.addEventListener('keyup', e => {
            switch (e.key.toLowerCase()) {
                case 'a': keys.a.pressed = false; break;
                case 'd': keys.d.pressed = false; break;
            }
        });

        function detectCollision(attacker, defender) {
            const ax = attacker.facing === 'right' ? attacker.position.x + attacker.width : attacker.position.x - attacker.attackWidth;
            const ay = attacker.position.y + attacker.attackOffsetY;
            return ax + attacker.attackWidth >= defender.position.x &&
                   ax <= defender.position.x + defender.width &&
                   ay + attacker.attackHeight >= defender.position.y &&
                   ay <= defender.position.y + defender.height;
        }

        function drawHealth() {
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(30, 20, 220, 40);
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(35, 25, (isHost ? myHealth : opponentHealth) * 2.1, 30);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('P1', 40, 50);

            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(canvas.width - 250, 20, 220, 40);
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(canvas.width - 245, 25, (isHost ? opponentHealth : myHealth) * 2.1, 30);
            ctx.fillStyle = 'white';
            ctx.fillText('P2', canvas.width - 240, 50);
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ƒë·∫•t
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);

            myFighter.update();
            opponentFighter.update();
            drawHealth();

            // di chuy·ªÉn
            myFighter.velocity.x = 0;
            if (keys.a.pressed) { myFighter.velocity.x = -7; myFighter.facing = 'left'; }
            else if (keys.d.pressed) { myFighter.velocity.x = 7; myFighter.facing = 'right'; }

            // va ch·∫°m t·∫•n c√¥ng
            if (myFighter.isAttacking && detectCollision(myFighter, opponentFighter) && opponentFighter.damageCooldown <= 0) {
                let dmg = myFighter.attackDamage;
                if (opponentFighter.isBlocking) dmg = Math.floor(dmg / 2);
                if (opponentFighter.isDashing) dmg = 0;
                if (dmg > 0) {
                    opponentHealth -= dmg;
                    opponentFighter.damageCooldown = 20;
                    if (conn?.open) conn.send({ type: 'damage', amount: dmg });
                }
            }
            if (opponentFighter.isAttacking && detectCollision(opponentFighter, myFighter) && myFighter.damageCooldown <= 0) {
                let dmg = opponentFighter.attackDamage;
                if (myFighter.isBlocking) dmg = Math.floor(dmg / 2);
                if (myFighter.isDashing) dmg = 0;
                if (dmg > 0) {
                    myHealth -= dmg;
                    myFighter.damageCooldown = 20;
                }
            }

            // k·∫øt th√∫c
            if (myHealth <= 0 || opponentHealth <= 0) {
                ctx.fillStyle = 'rgba(0,0,0,0.9)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 60px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(myHealth <= 0 ? 'P2 TH·∫ÆNG!' : 'P1 TH·∫ÆNG!', canvas.width / 2, canvas.height / 2);
                return;
            }

            requestAnimationFrame(animate);
        }

        function setupConnection() {
            conn.on('data', data => {
                if (data.type === 'state') {
                    opponentFighter.position = data.position;
                    opponentFighter.velocity = data.velocity;
                    opponentFighter.facing = data.facing;
                    opponentFighter.isAttacking = data.isAttacking;
                    opponentFighter.isDashing = data.isDashing;
                    opponentFighter.isBlocking = data.isBlocking;
                    opponentFighter.attackDamage = data.attackDamage;
                    opponentFighter.attackWidth = data.attackWidth;
                    opponentFighter.attackHeight = data.attackHeight;
                    opponentFighter.attackOffsetY = data.attackOffsetY;
                    opponentHealth = data.health;
                } else if (data.type === 'damage') {
                    myHealth -= data.amount;
                    if (myHealth < 0) myHealth = 0;
                }
            });

            setInterval(() => {
                if (conn?.open && myFighter) {
                    conn.send({
                        type: 'state',
                        position: { x: myFighter.position.x, y: myFighter.position.y },
                        velocity: { x: myFighter.velocity.x, y: myFighter.velocity.y },
                        facing: myFighter.facing,
                        isAttacking: myFighter.isAttacking,
                        isDashing: myFighter.isDashing,
                        isBlocking: myFighter.isBlocking,
                        attackDamage: myFighter.attackDamage,
                        attackWidth: myFighter.attackWidth,
                        attackHeight: myFighter.attackHeight,
                        attackOffsetY: myFighter.attackOffsetY,
                        health: myHealth
                    });
                }
            }, 40);
        }

        function startGame() {
            menu.style.display = 'none';
            canvas.style.display = 'block';
            if (isMobile) controls.style.display = 'block';

            const leftX = 100;
            const rightX = canvas.width - 160;

            myFighter = new Fighter({ position: { x: isHost ? leftX : rightX, y: 0 }, color: isHost ? 'blue' : 'red', facing: isHost ? 'right' : 'left' });
            myFighter.name = isHost ? 'P1' : 'P2';

            opponentFighter = new Fighter({ position: { x: isHost ? rightX : leftX, y: 0 }, color: isHost ? 'red' : 'blue', facing: isHost ? 'left' : 'right' });
            opponentFighter.name = isHost ? 'P2' : 'P1';

            setupConnection();
            animate();
        }

        document.getElementById('createBtn').onclick = () => {
            peer = new Peer();
            peer.on('open', id => {
                document.getElementById('hostIdDisplay').innerHTML = `ID Ph√≤ng: <strong>${id}</strong><br>G·ª≠i cho b·∫°n b√®!`;
            });
            peer.on('connection', c => {
                conn = c;
                isHost = true;
                startGame();
            });
        };

        document.getElementById('joinBtn').onclick = () => {
            const id = document.getElementById('joinIdInput').value.trim();
            if (!id) return alert('Nh·∫≠p ID!');
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(id);
                conn.on('open', () => {
                    isHost = false;
                    startGame();
                });
            });
        };
    </script>
</body>
</html>
